# Rocky Linux 10 Live-ISO für P2V/V2V Migration Toolkit

# -------------------------------------------------------------------
# Locale / Keyboard / Timezone
# -------------------------------------------------------------------
lang de_DE.UTF-8
keyboard --vckeymap=de --xlayouts='de'
timezone Europe/Berlin --utc

# -------------------------------------------------------------------
# Netzwerk & Dienste
# -------------------------------------------------------------------
firewall --enabled --service=ssh
services --enabled=NetworkManager,sshd,systemd-timesyncd
network --bootproto=dhcp --device=link --activate

# -------------------------------------------------------------------
# Benutzer / Authentifizierung
# -------------------------------------------------------------------
rootpw --lock
user --name=liveuser --groups=wheel --plaintext --password=""

# -------------------------------------------------------------------
# Repository (Pflicht für livemedia-creator)
# Hinweis: LMC unterstützt nur url/nfs/ostreesetup – kein liveimg!
# -------------------------------------------------------------------
url --mirrorlist="https://mirrors.rockylinux.org/mirrorlist?repo=baseos&arch=x86_64&release=9"
repo --name="appstream" --mirrorlist="https://mirrors.rockylinux.org/mirrorlist?repo=appstream&arch=x86_64&release=9"

# -------------------------------------------------------------------
# Pakete
# -------------------------------------------------------------------
%packages
# Basis-System
@core
dracut-live

# Virtualisierung / Migration
virt-v2v
virt-p2v
virt-install
libguestfs-tools
guestfs-tools
libguestfs-xfs
libguestfs-btrfs
qemu-kvm
qemu-img
libvirt-client
virt-viewer

# Storage / RAID / FS
mdadm
dmraid
lvm2
parted
gdisk
gptfdisk
lsblk
xfsprogs
btrfs-progs
e2fsprogs
ntfs-3g
dosfstools
exfatprogs
cryptsetup

# HW / Diagnose
pciutils
usbutils
lshw
lsscsi
smartmontools
nvme-cli
hdparm
sg3_utils
dmidecode

# Netzwerk / Tools
iproute
iputils
ethtool
curl
wget
openssh-clients
nfs-utils
cifs-utils
dnsmasq
bind-utils
nmap-ncat
tcpdump
iperf3
mtr
jq

# Shell / Editor / Debugging
tmux
vim
strace
lsof
psmisc

# Internationalisierung
langpacks-de
fonts-dejavu

# TUI (für späteren Assistenten)
dialog
%end

# -------------------------------------------------------------------
# Post-Installation
# -------------------------------------------------------------------
%post --log=/root/ks-post.log
set -euo pipefail

# sudo ohne Passwort für liveuser
mkdir -p /etc/sudoers.d
echo 'liveuser ALL=(ALL) NOPASSWD: ALL' > /etc/sudoers.d/90-liveuser
chmod 0440 /etc/sudoers.d/90-liveuser

# Dracut: breite Treiber/Module für RAID/LVM/FS/UEFI
mkdir -p /etc/dracut.conf.d
cat > /etc/dracut.conf.d/10-p2v.conf <<'EOF'
add_drivers+=" megaraid_sas mpt3sas mptsas mptspi aacraid hpsa ahci nvme dm_mod dm_crypt "
add_dracutmodules+=" mdraid lvm crypt udev-rules livenet nfs "
filesystems+=" xfs btrfs vfat ext4 ntfs3 "
hostonly="no"
EOF
dracut -f

# Auto-Storage-Erkennung (nur read-only Mounts)
install -m 0755 /usr/local/sbin/auto-detect-storage.sh <<'EOS'
#!/usr/bin/env bash
set -euo pipefail
LOG=/var/log/auto-storage.log
exec >>"$LOG" 2>&1
echo "== Auto Storage Detection (RO) =="

command -v mdadm >/dev/null && mdadm --assemble --scan || true
command -v vgchange >/dev/null && vgchange -ay || true
command -v dmraid >/dev/null && dmraid -ay || true

mkdir -p /mnt/src
lsblk -rno NAME,TYPE | awk '$2=="part"{print $1}' | while read -r part; do
  dev="/dev/${part}"
  fstype=$(blkid -s TYPE -o value "$dev" || true)
  mp="/mnt/src/${part}"
  [ -z "$fstype" ] && continue
  mkdir -p "$mp"
  case "$fstype" in
    ntfs)  mount -t ntfs-3g -o ro "$dev" "$mp" || rmdir "$mp" ;;
    exfat) mount -t exfat   -o ro "$dev" "$mp" || rmdir "$mp" ;;
    vfat|msdos|fat) mount -t vfat -o ro "$dev" "$mp" || rmdir "$mp" ;;
    xfs|ext4|ext3|ext2|btrfs) mount -o ro "$dev" "$mp" || rmdir "$mp" ;;
    *) echo "Skip $dev (fstype=$fstype)"; rmdir "$mp" || true ;;
  esac
done
echo "== Done =="
EOS

# Systemd-Service für Auto-Storage
cat > /etc/systemd/system/postlive-firstboot.service <<'EOS2'
[Unit]
Description=Initial storage auto-detect (RO mounts for P2V)
After=multi-user.target

[Service]
Type=oneshot
ExecStart=/usr/local/sbin/auto-detect-storage.sh

[Install]
WantedBy=multi-user.target
EOS2

systemctl enable postlive-firstboot.service || true

%end
