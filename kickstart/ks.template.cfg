#version=RHEL9
# -----------------------------------------------------------------------------
# OS-LVirt-Migrationassistant Kickstart Template
# Compatible with Rocky 9 + 10 (Lorax v34â€“v40)
# -----------------------------------------------------------------------------

# --- System Locale / Region --------------------------------------------------
lang de_DE.UTF-8
keyboard de
timezone Europe/Berlin --utc

# --- Root Password -----------------------------------------------------------
rootpw --plaintext oslv

# --- Security / System Options ----------------------------------------------
firewall --disabled
selinux --disabled
services --enabled="sshd,network"
reboot

# --- Network -----------------------------------------------------------------
network --bootproto=dhcp --device=link --activate

# --- Bootloader / BIOS-UEFI Setup -------------------------------------------
bootloader --timeout=3 --location=mbr --boot-drive=sda

# --- Storage Configuration ---------------------------------------------------
# Required for livemedia-creator to calculate disk size correctly
clearpart --all --initlabel
part /boot/efi --fstype=efi --size=200 --fsoptions="umask=0077,shortname=winnt"
part /boot --fstype=xfs --size=500
part swap --size=1024
part / --fstype=xfs --grow --size=8192

# --- Installation Source (required for livemedia-creator) --------------------
# The GitHub workflow substitutes these variables dynamically
url --url=$BASEURL

# --- Repositories ------------------------------------------------------------
repo --name="baseos" --baseurl=$BASEURL
repo --name="appstream" --baseurl=$APPSTREAMURL
repo --name="extras" --baseurl=$EXTRASURL

# --- Packages ----------------------------------------------------------------
%packages
@core

# --- Base + Live Tools ---
anaconda-tui
lorax
lorax-lmc-virt
dracut-live
dracut-network
dracut-config-rescue

# --- Virtualization / Conversion Stack ---
virt-v2v
virt-p2v
virt-install
virt-manager
virt-viewer
libguestfs-tools
guestfs-tools
libvirt
qemu-img
qemu-kvm
qemu-system-x86

# --- Filesystems / Storage / RAID ---
ntfs-3g
dosfstools
mdadm
smartmontools
parted
lvm2
xfsprogs
e2fsprogs
btrfs-progs

# --- libblockdev stack (required for Anaconda Storage init) ---
libblockdev
libblockdev-lvm
libblockdev-mdraid
libblockdev-part
libblockdev-fs
libblockdev-nvme
libblockdev-loop
blivet
python3-blivet
python3-blockdev

# --- Networking / Utilities ---
network-scripts
ethtool
iproute
iputils
curl
wget
rsync
openssh-clients
tar
zip
unzip

# --- System Tools ---
vim-minimal
nano
less
bash-completion
man-db
pciutils
lsblk
lshw
hwinfo
screen
tmux
htop
lsof
psmisc

# --- Diagnostics ---
strace
sysstat
iotop
dmidecode
efibootmgr

# --- Optional GUI (for later Migration Assistant frontend) ---
xorg-x11-server-Xorg
xorg-x11-xauth
xorg-x11-utils
xterm
openbox
lightdm
xsetroot

# --- Graphical helper packages ---
python3-gobject
python3-requests
python3-pyyaml
python3-jinja2
python3-click
python3-dbus

%end

# --- Post Installation ------------------------------------------------------
%post
echo "Welcome to OS-LVirt-Migrationassistant Live System" > /etc/motd

# Create default user for Live mode
useradd -m -G wheel -s /bin/bash oslv
echo "oslv:oslv" | chpasswd

# Enable SSH root login for migration
sed -i 's/^#PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config || true
systemctl enable sshd || true

# Mark build info
BUILD_DATE=$(date '+%Y-%m-%d %H:%M:%S')
echo "Build completed: $BUILD_DATE" >> /etc/os-release

%end
