#version=RHEL9
# -----------------------------------------------------------------------------
# OS-LVirt-Migrationassistant Kickstart Template
# Compatible with Rocky 9 + 10 (Lorax v34–v40)
# -----------------------------------------------------------------------------

# --- System Locale / Region --------------------------------------------------
lang de_DE.UTF-8
keyboard de
timezone Europe/Berlin --utc

# --- Root Password -----------------------------------------------------------
rootpw --plaintext oslv

# --- Security / System Options ----------------------------------------------
firewall --disabled
selinux --disabled
services --enabled="sshd,network"
reboot

# --- Network -----------------------------------------------------------------
network --bootproto=dhcp --device=link --activate

# --- Bootloader / BIOS-UEFI Setup -------------------------------------------
bootloader --timeout=3 --location=mbr --boot-drive=sda

# --- Storage Configuration ---------------------------------------------------
# Required so livemedia-creator can size the target image
clearpart --all --initlabel
part /boot/efi --fstype=efi --size=200 --fsoptions="umask=0077,shortname=winnt"
part /boot     --fstype=xfs --size=500
part swap      --size=1024
part /         --fstype=xfs --grow --size=8192

# --- Installation Source (required by livemedia-creator) --------------------
url --url=$BASEURL

# --- Repositories ------------------------------------------------------------
repo --name="baseos"    --baseurl=$BASEURL
repo --name="appstream" --baseurl=$APPSTREAMURL
repo --name="extras"    --baseurl=$EXTRASURL

# --- Packages ----------------------------------------------------------------
%packages
@core

# Live / Installer essentials
anaconda-tui
lorax
lorax-lmc-virt
dracut-live
dracut-network
dracut-config-rescue

# Virtualization / Conversion Stack
virt-v2v
virt-p2v
virt-install
virt-manager
virt-viewer
libguestfs-tools
guestfs-tools
libvirt
qemu-img
qemu-kvm
qemu-system-x86

# Filesystems / Storage / RAID basics
ntfs-3g
dosfstools
xfsprogs
e2fsprogs
btrfs-progs
parted
lvm2
mdadm
smartmontools
kpartx

# ---- libblockdev / blivet stack (Anaconda Storage) ----
# Core + plugins (cover nvme, crypto, mdraid, dm, mpath, fs, part, loop, swap)
libblockdev
libblockdev-part
libblockdev-fs
libblockdev-loop
libblockdev-lvm
libblockdev-mdraid
libblockdev-dm
libblockdev-mpath
libblockdev-swap
libblockdev-nvme
libblockdev-crypto
blivet
python3-blivet
python3-blockdev
blivet-data

# NVMe userspace (needed by nvme plugin on some releases)
libnvme
nvme-cli

# Multipath / device-mapper (sometimes required by blivet backends)
device-mapper-multipath

# Networking / Utilities
ethtool
iproute
iputils
curl
wget
rsync
openssh-clients
tar
zip
unzip
jq

# System Tools
vim-minimal
nano
less
bash-completion
man-db
pciutils
lsblk
lshw
hwinfo
screen
tmux
htop
lsof
psmisc
dmidecode
efibootmgr
strace
sysstat
iotop

# Optional minimal X (späterer GUI-Assistent)
xorg-x11-server-Xorg
xorg-x11-xauth
xorg-x11-utils
xterm
openbox
lightdm
xsetroot

# Python libs für spätere Tools
python3-gobject
python3-requests
python3-pyyaml
python3-jinja2
python3-click
python3-dbus
%end

# --- Post Installation ------------------------------------------------------
%post
echo "Welcome to OS-LVirt-Migrationassistant Live System" > /etc/motd

# Live-User
useradd -m -G wheel -s /bin/bash oslv
echo "oslv:oslv" | chpasswd

# SSH Root-Login erlauben (für Migrationstools)
sed -i 's/^#\?PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config || true
systemctl enable sshd || true

# Build-Info
BUILD_DATE=$(date '+%Y-%m-%d %H:%M:%S')
echo "Build completed: $BUILD_DATE" >> /etc/os-release
%end
