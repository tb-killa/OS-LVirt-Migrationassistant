name: Build ISO (Dual Rocky 9 + 10)

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:
  schedule:
    - cron: '30 2 * * *'   # täglich 02:30 UTC

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - rel: 9
            tag: stable
            baseurl: http://dl.rockylinux.org/pub/rocky/9
          - rel: 10
            tag: beta
            baseurl: http://dl.rockylinux.org/pub/rocky/10
    name: Build ISO for Rocky${{ matrix.rel }} (${{ matrix.tag }})

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Host-seitige Vorabprüfung der Kickstart-Syntax
      - name: Validate Kickstart syntax (host pre-check)
        run: |
          echo "=== Installing pykickstart via PyPI ==="
          sudo apt-get update -qq
          sudo apt-get -y install python3-pip gettext
          pip install pykickstart
          echo "=== Basic validation of kickstart template ==="
          ksvalidator kickstart/ks.template.cfg || echo "⚠️ Kickstart syntax warnings"

      # Container-Build (Rocky 9 / 10 Matrix)
      - name: Build ISO inside Rocky container
        run: |
          echo "=== Pull container and start build for Rocky${{ matrix.rel }} ==="
          docker pull rockylinux:${{ matrix.rel }}
          docker run --rm -v "${{ github.workspace }}":/workspace -w /workspace \
            rockylinux:${{ matrix.rel }} /bin/bash -e <<'EOF'

            echo "=== Preparing environment for Rocky${{ matrix.rel }} ==="
            dnf -y --allowerasing --nobest install \
              ca-certificates dnf dnf-plugins-core curl python3-pip python3-setuptools

            echo "=== Installing core build deps ==="
            dnf -y --allowerasing --nobest install \
              lorax lorax-lmc-virt anaconda-tui pykickstart \
              qemu-img xz rpm-build make git gettext \
              blivet-data libblockdev libblockdev-nvme libblockdev-crypto \
              libnvme nvme-cli device-mapper-multipath kpartx \
              dracut-live dracut-network

            echo "=== Configure temporary build repos ==="
            cat > /etc/yum.repos.d/build.repo <<REPO
            [build-baseos]
            name=Rocky${{ matrix.rel }} Build BaseOS
            baseurl=${{ matrix.baseurl }}/BaseOS/x86_64/os/
            enabled=1
            gpgcheck=0

            [build-appstream]
            name=Rocky${{ matrix.rel }} Build AppStream
            baseurl=${{ matrix.baseurl }}/AppStream/x86_64/os/
            enabled=1
            gpgcheck=0

            [build-extras]
            name=Rocky${{ matrix.rel }} Build Extras
            baseurl=${{ matrix.baseurl }}/extras/x86_64/os/
            enabled=1
            gpgcheck=0
            REPO

            dnf repolist || true

            echo "=== Resolve KS repo paths (v10 fallback aware) ==="
            if [ "${{ matrix.rel }}" = "10" ]; then
              GA_BASE="http://dl.rockylinux.org/pub/rocky/10"
              DEV_BASE="http://download.rockylinux.org/pub/rocky/10/development"
              if curl -sfI "$GA_BASE/BaseOS/x86_64/os/repodata/repomd.xml" >/dev/null; then
                export BASEURL="$GA_BASE/BaseOS/x86_64/os/"
                export APPSTREAMURL="$GA_BASE/AppStream/x86_64/os/"
                export EXTRASURL="$GA_BASE/extras/x86_64/os/"
                echo "→ Using Rocky10 GA repos"
              else
                export BASEURL="$DEV_BASE/BaseOS/x86_64/os/"
                export APPSTREAMURL="$DEV_BASE/AppStream/x86_64/os/"
                export EXTRASURL="$DEV_BASE/extras/x86_64/os/"
                echo "→ Using Rocky10 development repos"
              fi
            else
              export BASEURL="${{ matrix.baseurl }}/BaseOS/x86_64/os/"
              export APPSTREAMURL="${{ matrix.baseurl }}/AppStream/x86_64/os/"
              export EXTRASURL="${{ matrix.baseurl }}/extras/x86_64/os/"
            fi

            echo "=== Sanity check repomd.xml ==="
            for R in "$BASEURL" "$APPSTREAMURL" "$EXTRASURL"; do
              echo "Check: $R"
              curl -sfI "${R}repodata/repomd.xml" || echo "⚠️ Repo not reachable: $R"
            done

            echo "=== Render KS ==="
            envsubst < kickstart/ks.template.cfg > /tmp/ks.effective.cfg

            echo "=== Validate Kickstart (container) ==="
            ksvalidator /tmp/ks.effective.cfg || echo "⚠️ Validation warnings (ignored)"

            echo "=== Start ISO Build ==="
            chmod +x scripts/mkiso.sh
            ISO_NAME="OS-LVirt-Migrationassistant-${{ matrix.rel }}-${{ matrix.tag }}-$(date +%Y%m%d)"
            TAG="${{ matrix.tag }}"
            RELEASEVER="${{ matrix.rel }}"
            scripts/mkiso.sh /tmp/ks.effective.cfg /tmp/build

          EOF

      # Schneller Check: ISO existiert & Größe anzeigen
      - name: Quick ISO existence check
        if: always()
        run: |
          echo "=== Verifying generated ISO ==="
          find build -type f -name "*.iso" -exec ls -lh {} \; || echo "⚠️ No ISO built"
          ls -lh build || true

      # Bootstruktur-Check (EFI/BIOS) mit xorriso auf dem Host
      - name: Verify ISO boot structure (xorriso)
        if: success()
        run: |
          sudo apt-get update -qq
          sudo apt-get -y install xorriso
          ISO_FILE="$(ls build/*.iso | head -n1)"
          if [ -n "$ISO_FILE" ]; then
            echo "=== xorriso El Torito report ==="
            xorriso -indev "$ISO_FILE" -report_el_torito as_mkisofs
          else
            echo "⚠️ No ISO found for boot structure check"
          fi

      - name: Upload ISO Artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: OS-LVirt-${{ matrix.rel }}-${{ matrix.tag }}
          path: build/*.iso
