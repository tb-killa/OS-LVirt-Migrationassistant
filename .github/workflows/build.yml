name: build-and-test-iso

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
  schedule:
    - cron: "17 2 * * *"

env:
  IMAGE_ROCKY9: rockylinux:9
  IMAGE_ROCKY10: rockylinux:10

jobs:
  build:
    name: Build ISO (${{ matrix.rel }} ${{ matrix.tag }})
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - rel: "9"
            tag: "stable"
            baseurl: "http://dl.rockylinux.org/pub/rocky/9"
          - rel: "10"
            tag: "beta"
            baseurl: "http://dl.rockylinux.org/pub/rocky/10"

    steps:
      - uses: actions/checkout@v4

      # 1Ô∏è‚É£  Vorabpr√ºfung Kickstart
      - name: Validate Kickstart syntax (pre-build)
        run: |
          echo "=== Installing pykickstart via PyPI ==="
          sudo apt-get update -qq
          sudo apt-get -y install python3-pip gettext
          pip install pykickstart

          echo "=== Validate ks.template.cfg ==="
          ksvalidator kickstart/ks.template.cfg || { echo "‚ùå KS validation failed"; exit 1; }

          echo "=== Render with sample vars ==="
          export BASEURL="http://dl.rockylinux.org/pub/rocky/9/BaseOS/x86_64/os/"
          export APPSTREAMURL="http://dl.rockylinux.org/pub/rocky/9/AppStream/x86_64/os/"
          export EXTRASURL="http://dl.rockylinux.org/pub/rocky/9/extras/x86_64/os/"
          envsubst < kickstart/ks.template.cfg > /tmp/ks.test.cfg

          ksvalidator /tmp/ks.test.cfg || { echo "‚ùå Rendered KS invalid"; exit 1; }
          echo "‚úÖ Kickstart syntax OK"

      # 2Ô∏è‚É£  Container-Build
      - name: Select available Rocky base image
        id: baseimg
        run: |
          if docker manifest inspect "rockylinux:${{ matrix.rel }}" >/dev/null 2>&1; then
            echo "base=rockylinux:${{ matrix.rel }}" >> "$GITHUB_OUTPUT"
          else
            echo "base=rockylinux:9" >> "$GITHUB_OUTPUT"
          fi

      - name: Build ISO inside Rocky container
        uses: addnab/docker-run-action@v3
        with:
          image: ${{ steps.baseimg.outputs.base }}
          options: -v ${{ github.workspace }}:/workspace -w /workspace --rm --privileged
          run: |
            set -eux

            echo "=== Preparing build env for Rocky${{ matrix.rel }} ==="
            dnf clean all
            dnf -y --allowerasing --nobest install ca-certificates dnf dnf-plugins-core curl || \
              dnf -y reinstall ca-certificates

            # üîí Repos bereinigen
            rm -rf /etc/yum.repos.d/*
            cat > /etc/yum.repos.d/rocky${{ matrix.rel }}-build.repo <<EOF
            [build-baseos]
            name=Rocky${{ matrix.rel }} Build BaseOS
            baseurl=${{ matrix.baseurl }}/BaseOS/x86_64/os/
            enabled=1
            gpgcheck=0

            [build-appstream]
            name=Rocky${{ matrix.rel }} Build AppStream
            baseurl=${{ matrix.baseurl }}/AppStream/x86_64/os/
            enabled=1
            gpgcheck=0

            [build-extras]
            name=Rocky${{ matrix.rel }} Build Extras
            baseurl=${{ matrix.baseurl }}/extras/x86_64/os/
            enabled=1
            gpgcheck=0
            EOF

            echo "=== Repo sanity for Rocky${{ matrix.rel }} ==="
            dnf repolist || true

            # üß± Lorax-Abh√§ngigkeiten
            dnf -y --allowerasing --nobest install lorax lorax-lmc-virt anaconda-tui pykickstart qemu-img xz rpm-build make git gettext

            # üåê v10-Fallback-Erkennung
            echo "=== Resolve KS repo paths (v10 fallback aware) ==="
            if [ "${{ matrix.rel }}" = "10" ]; then
              GA_BASE="http://dl.rockylinux.org/pub/rocky/10"
              DEV_BASE="http://download.rockylinux.org/pub/rocky/10/development"
              if curl -sfI "${GA_BASE}/BaseOS/x86_64/os/repodata/repomd.xml" >/dev/null; then
                export BASEURL="${GA_BASE}/BaseOS/x86_64/os/"
                export APPSTREAMURL="${GA_BASE}/AppStream/x86_64/os/"
                export EXTRASURL="${GA_BASE}/extras/x86_64/os/"
                echo "‚Üí Using Rocky10 GA repos"
              elif curl -sfI "${DEV_BASE}/BaseOS/x86_64/os/repodata/repomd.xml" >/dev/null; then
                export BASEURL="${DEV_BASE}/BaseOS/x86_64/os/"
                export APPSTREAMURL="${DEV_BASE}/AppStream/x86_64/os/"
                export EXTRASURL="${DEV_BASE}/extras/x86_64/os/"
                echo "‚Üí Using Rocky10 development repos"
              else
                echo "ERROR: no valid Rocky10 repo found"
                exit 8
              fi
            else
              export BASEURL="${{ matrix.baseurl }}/BaseOS/x86_64/os/"
              export APPSTREAMURL="${{ matrix.baseurl }}/AppStream/x86_64/os/"
              export EXTRASURL="${{ matrix.baseurl }}/extras/x86_64/os/"
            fi

            echo "=== Sanity check repomd.xml ==="
            for R in "$BASEURL" "$APPSTREAMURL" "$EXTRASURL"; do
              echo "Check: $R"
              curl -sfI "${R}repodata/repomd.xml" >/dev/null || { echo "ERROR: Missing repomd.xml"; exit 7; }
            done

            echo "=== Render KS ==="
            envsubst < kickstart/ks.template.cfg > /tmp/ks.effective.cfg
            ksvalidator /tmp/ks.effective.cfg

            echo "=== Start ISO Build ==="
            chmod +x scripts/mkiso.sh
            ISO_NAME="OS-LVirt-Migrationassistant-${{ matrix.rel }}-${{ matrix.tag }}-$(date +%Y%m%d)"
            TAG=${{ matrix.tag }} RELEASEVER=${{ matrix.rel }} scripts/mkiso.sh /tmp/ks.effective.cfg /tmp/build

            chmod +x tools/gen-changelog.sh
            RELEASEVER=${{ matrix.rel }} TAG=${{ matrix.tag }} tools/gen-changelog.sh /tmp/build/CHANGELOG.md

            mkdir -p build/${{ matrix.rel }}
            cp -v /tmp/build/* build/${{ matrix.rel }}/

            cd build/${{ matrix.rel }}
            tar -czf OS-LVirt-Migrationassistant-${{ matrix.rel }}-${{ matrix.tag }}-${GITHUB_RUN_NUMBER}.tar.gz *.iso *.sha256 lmc.log CHANGELOG.md

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: iso-artifacts-${{ matrix.rel }}
          path: |
            build/${{ matrix.rel }}/*.tar.gz
            build/${{ matrix.rel }}/*.iso
            build/${{ matrix.rel }}/*.sha256
            build/${{ matrix.rel }}/lmc.log
            build/${{ matrix.rel }}/CHANGELOG.md

  # 3Ô∏è‚É£  Smoke-Test (nur Rocky9)
  test:
    name: Smoke tests (BIOS & UEFI)
    runs-on: ubuntu-latest
    needs: build
    strategy:
      matrix:
        mode: [ bios, uefi ]

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: iso-artifacts-9
          path: dist

      - name: Install QEMU (+ OVMF)
        run: |
          sudo apt-get update -qq
          sudo apt-get -y install qemu-system-x86 ovmf

      - name: Run smoke test (${{ matrix.mode }})
        run: |
          ISO=$(ls dist/*.iso | head -n1)
          if [ "${{ matrix.mode }}" = "uefi" ]; then
            qemu-system-x86_64 -m 1024 -cdrom "$ISO" -enable-kvm -bios /usr/share/OVMF/OVMF_CODE.fd -display none -boot d -no-reboot -serial stdio -timeout 60 || true
          else
            qemu-system-x86_64 -m 1024 -cdrom "$ISO" -enable-kvm -display none -boot d -no-reboot -serial stdio -timeout 60 || true
          fi
