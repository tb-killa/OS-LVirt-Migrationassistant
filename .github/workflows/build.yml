name: build-and-test-iso

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
  schedule:
    - cron: "17 2 * * *"  # täglich 02:17 UTC

env:
  IMAGE_ROCKY9: rockylinux:9
  IMAGE_ROCKY10: rockylinux:10

jobs:
  build:
    name: Build ISO (${{ matrix.rel }} ${{ matrix.tag }})
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - rel: "9"
            tag: "stable"
            baseurl: "http://dl.rockylinux.org/pub/rocky/9"
          - rel: "10"
            tag: "beta"
            baseurl: "http://dl.rockylinux.org/pub/rocky/devel/10"

    steps:
      - uses: actions/checkout@v4

      - name: Select available Rocky base image
        id: baseimg
        run: |
          set -e
          if docker manifest inspect "rockylinux:${{ matrix.rel }}" >/dev/null 2>&1; then
            echo "base=rockylinux:${{ matrix.rel }}" >> "$GITHUB_OUTPUT"
          else
            echo "rockylinux:${{ matrix.rel }} not found — falling back to rockylinux:9"
            echo "base=rockylinux:9" >> "$GITHUB_OUTPUT"
          fi

      - name: Build ISO inside Rocky container
        uses: addnab/docker-run-action@v3
        with:
          image: ${{ steps.baseimg.outputs.base }}
          options: -v ${{ github.workspace }}:/workspace -w /workspace
          run: |
            set -eux
            echo "=== Preparing Repo Definitions for Rocky${{ matrix.rel }} ==="
            dnf -y install ca-certificates dnf dnf-plugins-core curl
            cat > /etc/yum.repos.d/rocky.repo <<EOF
            [baseos]
            name=Rocky${{ matrix.rel }} BaseOS
            baseurl=${{ matrix.baseurl }}/BaseOS/x86_64/os/
            enabled=1
            gpgcheck=0
            
            [appstream]
            name=Rocky${{ matrix.rel }} AppStream
            baseurl=${{ matrix.baseurl }}/AppStream/x86_64/os/
            enabled=1
            gpgcheck=0
            
            [extras]
            name=Rocky${{ matrix.rel }} Extras
            baseurl=${{ matrix.baseurl }}/extras/x86_64/os/
            enabled=1
            gpgcheck=0
            EOF

            dnf -y install lorax lorax-lmc-virt anaconda-tui pykickstart qemu-img xz rpm-build make git

            echo "=== Validating kickstart ==="
            ksvalidator kickstart/ks.cfg

            chmod +x scripts/mkiso.sh
            ISO_NAME="OS-LVirt-Migrationassistant-${{ matrix.rel }}-${{ matrix.tag }}-$(date +%Y%m%d)"
            TAG=${{ matrix.tag }} RELEASEVER=${{ matrix.rel }} scripts/mkiso.sh kickstart/ks.cfg /tmp/build

            chmod +x tools/gen-changelog.sh
            tools/gen-changelog.sh /tmp/build/CHANGELOG.md

            mkdir -p build/${{ matrix.rel }}
            cp -v /tmp/build/* build/${{ matrix.rel }}/

            cd build/${{ matrix.rel }}
            tar -czf OS-LVirt-Migrationassistant-${{ matrix.rel }}-${{ matrix.tag }}-${GITHUB_RUN_NUMBER}.tar.gz *.iso *.sha256 lmc.log CHANGELOG.md

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: iso-artifacts-${{ matrix.rel }}
          path: |
            build/${{ matrix.rel }}/*.tar.gz
            build/${{ matrix.rel }}/*.iso
            build/${{ matrix.rel }}/*.iso.sha256
            build/${{ matrix.rel }}/lmc.log
            build/${{ matrix.rel }}/CHANGELOG.md

      - name: Build summary
        run: |
          echo "## Build Summary $(date)" >> "$GITHUB_STEP_SUMMARY"
          echo "Release: Rocky${{ matrix.rel }} (${{ matrix.tag }})" >> "$GITHUB_STEP_SUMMARY"
          echo "Container Image: ${{ steps.baseimg.outputs.base }}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          ls -lh build/${{ matrix.rel }}/*.iso | sed 's/^/- /' >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          sha256sum build/${{ matrix.rel }}/*.iso | sed 's/^/    /' >> "$GITHUB_STEP_SUMMARY"

  test:
    name: Smoke tests (BIOS & UEFI, stable only)
    runs-on: ubuntu-latest
    needs: build
    strategy:
      matrix:
        mode: [ bios, uefi ]
    if: ${{ always() && contains(needs.build.outputs['matrix.rel'], '9') }}

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: iso-artifacts-9
          path: dist

      - name: Install QEMU (+ OVMF for UEFI)
        run: |
          sudo apt-get update
          if [ "${{ matrix.mode }}" = "uefi" ]; then
            sudo apt-get -y install qemu-system-x86 ovmf
          else
            sudo apt-get -y install qemu-system-x86
          fi

      - name: Run smoke test (${{ matrix.mode }})
        run: |
          chmod +x test/qemu-smoke-bios.sh test/qemu-smoke-uefi.sh
          ISO=$(ls dist/*.iso | head -n1)
          if [ "${{ matrix.mode }}" = "uefi" ]; then
            test/qemu-smoke-uefi.sh "$ISO"
          else
            test/qemu-smoke-bios.sh "$ISO"
          fi
